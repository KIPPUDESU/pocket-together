自建：docker-mailserver 、 Mailu ，有点麻烦

借助 outlook ，免费的也可以使用smtp。自己有e5账号，也能有域名邮箱

相关参考
- 开启微软 Outlook 邮箱 POP, IMAP, SMTP 服务和获取服务密码(授权码) https://blog.csdn.net/Coin_Collecter/article/details/129590620
- 使用 Cloudflare 和 Outlook 搭建无服务器的域名邮箱 https://www.sevenen.cn/archives/shi-yong-cloudflare-he-outlook-da-jian-wu-fu-wu-qi-de-yu-ming-you-xiang

开启双重验证 创建应用密码
https://account.live.com/proofs/manage/additional?mkt=zh-CN&refd=account.microsoft.com&refp=security&uaid=eea052ae8b4a4a43a7192d8d8d00bd21

试了试好像不行， pocketbase 的 smtp 不支持 outlook （因为 Authentication Method 之类的不支持）

看了看pocketbase官网，试了试其提到的 mailersend https://www.mailersend.com/ 成功发送了测试邮件，但自己没通过审核

最终还是决定自建

## 自建邮箱服务
参考
- 官网 https://docker-mailserver.github.io/docker-mailserver/latest/usage/
- 搭建一个属于自己的域名邮箱｜Docker-Mailserver详细教程 https://wmwm.me/article/456048926181560320

### DNS设置
```
类型 MX
名称 example.com
内容 mail.example.com
代理状态 仅DNS
TTL 自动
优先级 10

类型 A
名称 mail
IPv4 地址
代理状态 仅DNS
TTL 自动
```

### mailserver安装

#### Docker相关文件准备
访问 [https://github.com/docker-mailserver/docker-mailserver](https://github.com/docker-mailserver/docker-mailserver)， 找到compose.yaml和mailserver.env，复制并编辑其内容

compose.yaml 修改
```
hostname
提供您的邮件服务器的 FQDN（您的 DNS MX 记录应指向此值）
hostname: mail.example.com

SSL_TYPE
environment中添加环境变量 `SSL_TYPE=letsencrypt`
SSL_TYPE=letsencrypt

证书目录
把证书挂载到docker-mailserver容器中
- /root/certs/:/etc/letsencrypt/
```

参考
- [250726-使用1panel申请证书与自动续签](250726-使用1panel申请证书与自动续签.md)

修改后的 compose.yaml
```yaml
services:
  mailserver:
    image: ghcr.io/docker-mailserver/docker-mailserver:15.0.2
    container_name: mailserver
    # Provide the FQDN of your mail server here (Your DNS MX record should point to this value)
    hostname: mail.example.com
    env_file: mailserver.env
    # environment 的优先级更高，会覆盖.env文件中相同的环境变量
    environment:
      - SSL_TYPE=letsencrypt
      - TZ=Asia/Shanghai
    # More information about the mail-server ports:
    # https://docker-mailserver.github.io/docker-mailserver/latest/config/security/understanding-the-ports/
    ports:
      - "25:25"    # SMTP  (explicit TLS => STARTTLS, Authentication is DISABLED => use port 465/587 instead)
      - "143:143"  # IMAP4 (explicit TLS => STARTTLS)
      - "465:465"  # ESMTP (implicit TLS)
      - "587:587"  # ESMTP (explicit TLS => STARTTLS)
      - "55587:587"  # 新增映射：宿主机 55587 → 容器 587
      - "993:993"  # IMAP4 (implicit TLS)
    volumes:
      - /root/certs/:/etc/letsencrypt/
      - ./docker-data/dms/mail-data/:/var/mail/
      - ./docker-data/dms/mail-state/:/var/mail-state/
      - ./docker-data/dms/mail-logs/:/var/log/mail/
      - ./docker-data/dms/config/:/tmp/docker-mailserver/
      - /etc/localtime:/etc/localtime:ro
    restart: always
    stop_grace_period: 1m
    # Uncomment if using `ENABLE_FAIL2BAN=1`:
    # cap_add:
    #   - NET_ADMIN
    healthcheck:
      test: "ss --listening --ipv4 --tcp | grep --silent ':smtp' || exit 1"
      timeout: 3s
      retries: 0
```

mailserver.env 不用改
[250722-250727-mailserver.env](250722-250727-mailserver.env.md)

#### 安装
```
创建文件夹 /root/mailserver
复制 mailserver.env compose.yaml 至此文件夹
```

运行Docker-Mailserver
```bash
# 调试阶段，建议不要添加 -d 参数，看日志比较麻烦
docker compose up
```

运行后，有三件重要的事情要做
```
Docker Mailserver规定首次运行容器时**必须**创建第一个邮箱账号，否则容器会自动退出
# 邮箱前缀随意，不一定非要是admin
docker exec -it <CONTAINER NAME> setup email add admin@example.com

为postmaster@yourdomain.com这个邮箱地址添加一个别名(其实可以把刚才创建的第一个邮箱账号设置成postmaster的别名)
docker exec -it <CONTAINER NAME> setup alias add postmaster@example.com admin@example.com

验证https证书的有效性
docker exec <mailserver-container-name> openssl s_client \
  -connect 0.0.0.0:25 \
  -starttls smtp \
  -CApath /etc/ssl/certs/
docker exec <mailserver-container-name> openssl s_client \
  -connect 0.0.0.0:587 \
  -starttls smtp \
  -CApath /etc/ssl/certs/
```

#### 测试
```
暂时在pocketbase上试试，再创建一个邮箱，向admin发邮件，成功
测试向outlook邮箱发邮件，pocketbase显示成功，但在outlook上没有，垃圾邮件也没有
```

#### 完善其他配置
https://docker-mailserver.github.io/docker-mailserver/latest/config/best-practices/dkim_dmarc_spf/

DKIM
```
创建 DKIM 密钥
docker exec -it mailserver setup config dkim

进入volume挂载路径`./docker-data/dms/config/opendkim/keys/<yourdomain.com>`，可以看到mail.private 和 mail.txt 两个文件，将mail.txt上传到cloudflare的DNS记录中
（ <selector>.private <selector>.txt ）

DNS记录
类型 TXT
名称 <selector>._domainkey（默认：mail._domainkey)
内容 （格式请看官方文档）
```

SPF
```
DNS记录
类型 TXT
名称 example.com
内容 v=spf1 a mx ip4:123.123.123.123 -all
```

DMARC
https://docker-mailserver.github.io/docker-mailserver/latest/config/best-practices/dkim_dmarc_spf/#dmarc

设置完毕后重启mailserver

#### 使用说明
查看用户列表
```bash
docker exec -it mailserver setup email list
```

添加用户
```bash
docker exec -it mailserver setup email add <EMAIL ADDRESS> [<PASSWORD>]
# 比如
docker exec -it mailserver setup email add xxx@domain.com "password123"
```

修改邮箱账户的密码
```bash
docker exec -it mailserver setup email update <EMAIL ADDRESS> [<PASSWORD>]
# 比如
docker exec -it mailserver setup email update admin@domain.com "password123"
```

setup命令还有一些其他功能
```bash
# 查看setup命令帮助
docker exec -it mailserver setup
```


#### 记录遇到的问题
```
2507271430 开始

2507271435 遇到25端口占用问题，因为已有postfix
/etc/systemd/system/multi-user.target.wants/postfix.service
停止并禁止自启动
systemctl stop postfix
systemctl disable postfix

2507271657 发现用 1panel 的应用商店安装有问题，决定用正常docker

2507281744 不知道为什么自己的服务器不能用587，改用别的端口即可，不影响邮件服务

2507281916 明明各种东西都配置好了但 outlook gmail 都收不到邮件
```


